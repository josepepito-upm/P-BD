DELIMITER $$

CREATE FUNCTION porcentaje_pasajeros(
    p_destino_planeta VARCHAR(255), 
    p_destino_sistema VARCHAR(255),
    p_cubierta CHAR(1)
) 
RETURNS DECIMAL(5,2)
DETERMINISTIC
BEGIN
    DECLARE total_pasajeros INT DEFAULT 0;
    DECLARE pasajeros_destino INT DEFAULT 0;
    DECLARE porcentaje DECIMAL(5,2);

    SELECT COUNT(*) 
    INTO pasajeros_destino
    FROM pasajeros p 
    JOIN cabinas c ON p.numero_cabina = c.numero
    JOIN planetas pl ON p.planeta_destino = pl.nombre
    JOIN sistemas s ON pl.sistema = s.nombre
    WHERE c.cubierta = p_cubierta
      AND pl.nombre = p_destino_planeta
      AND s.nombre = p_destino_sistema;

    SELECT COUNT(*) 
    INTO total_pasajeros
    FROM pasajeros p 
    JOIN cabinas c ON p.numero_cabina = c.numero
    WHERE c.cubierta = p_cubierta;

    IF total_pasajeros > 0 THEN
        SET porcentaje = (pasajeros_destino / total_pasajeros) * 100;
    ELSE
        SET porcentaje = 0;
    END IF;

    RETURN porcentaje;
END$$

DELIMITER ;

SELECT c.cubierta, c.numero, c.lado, porcentaje_pasajeros('55 Cancri e', 'Copernico', c.cubierta) AS porcentaje_ocupacion
FROM cabinas c JOIN pasajeros p ON p.numero_cabina = c.numero
			   JOIN planetas pl ON p.planeta_destino = pl.nombre
			   JOIN sistemas s ON pl.sistema = s.nombre
WHERE pl.nombre = '55 Cancri e' AND s.nombre = 'Copernico'
GROUP BY c.cubierta, c.numero, c.lado
ORDER BY c.cubierta;
